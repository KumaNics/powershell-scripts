<#
.SYNOPSIS
    Script para inventariar certificados digitais A1, executado via GPO de Logon/Logoff.
#>

#---------------------------------------------------#
#                   CONFIGURACAO                    #
#---------------------------------------------------#

$CaminhoRepositorioCentral = "[INSIRA AQUI]"

#LOGICA DO SCRIPT
try {
    $dataVerificacao = Get-Date

    $NomeComputador = $env:COMPUTERNAME
    $NomeUsuario = $env:USERNAME

    $nomeArquivo = "$NomeComputador-$NomeUsuario.csv"
    $ArquivoDeSaida = Join-Path -Path $CaminhoRepositorioCentral -ChildPath $nomeArquivo

    if (-not (Test-Path -Path $CaminhoRepositorioCentral)) {
        New-Item -Path $CaminhoRepositorioCentral -ItemType Directory -Force | Out-Null
    }
    
    #LOCAIS DE INSTALACAO DOS CERTIFICADOS
    $LocaisVerificacao = @(
        "Cert:\CurrentUser\My",
        "Cert:\LocalMachine\My"
    )

    $certificadosEncontrados = @()

    #FILTRO DOS CERTIFICADOS
    foreach ($local in $LocaisVerificacao) {
        $certificadosInstalados = Get-ChildItem -Path $local | Where-Object { $_.HasPrivateKey } # <- FILTROS AQUI

        foreach ($cert in $certificadosInstalados) {
            $cnpj = ""
            if ($cert.Subject -match 'CNPJ:(\d{14})' -or $cert.Subject -match ':(\d{14})') {
                $cnpj = $matches[1]
            }

            #OBJETO PERSONALIZADO
            $infoCertificado = [PSCustomObject]@{
                Computador      = $NomeComputador
                UsuarioLogado   = $NomeUsuario
                CNPJ            = $cnpj
                Certificado     = $cert.Subject
                Emitente        = $cert.Issuer
                Validade        = $cert.NotAfter
                NumeroDeSerie   = $cert.SerialNumber
                Repositorio     = $local
                DataDaVerificacao = $dataVerificacao
            }
            $certificadosEncontrados += $infoCertificado
        }
    }

    if ($certificadosEncontrados.Count -gt 0) {
        $certificadosEncontrados | Export-Csv -Path $ArquivoDeSaida -NoTypeInformation -Encoding UTF8 -Delimiter ';'
    }

} catch {
    $mensagemErro = "[$([DateTime]::Now)] ERRO no computador ${NomeComputador} (UsuÃ¡rio: $NomeUsuario): $($_.Exception.Message)"
    $arquivoLogErro = Join-Path -Path $CaminhoRepositorioCentral -ChildPath "_log_de_erros.txt"
    Add-Content -Path $arquivoLogErro -Value $mensagemErro
}
